<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <title>Drone in Lund</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <link rel="stylesheet" type="text/css" href="static/style.css">
</head>
<body>
  <div class="order-info-container">
    <h3>Orderinformation</h3>
    <p><strong>Ordernummer:</strong> <span id="order-number">-</span></p>
    <p><strong>Leveransadress:</strong> <span id="delivery-address">-</span></p>
    <p><strong>Beställda produkter:</strong></p>
    <ul id="ordered-products"></ul>
    <p><strong>Total vikt:</strong> <span id="total-weight">-</span></p>
    <p><strong>Orderstatus:</strong> <span id="order-status">-</span></p>
    <button id="back-to-home" onclick="goBackToHome()">Till Huvudsidan</button>
    <button id="qr-scan-button" onclick="goToQRScanner()">Skanna QR-kod</button>
  </div>

  <object id="map" data="static/images/lund-map.svg" type="image/svg+xml"></object>

  <script type="text/javascript">
    function loadOrderDataFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const orderNr = params.get("ordernumber") || "-";
      const address = params.get("address")?.replace(/\+/g, ' ') || "-";
      const weight  = params.get("weight") || "-";
      const productListRaw = params.get("products");
      const orderStatus     = params.get("status") || "Okänd";

      document.getElementById("order-number").innerText       = orderNr;
      document.getElementById("delivery-address").innerText   = address;
      document.getElementById("total-weight").innerText       = weight + " mg";
      updateOrderStatus(orderStatus);

      if (productListRaw) {
        try {
          const correctedBase64 = productListRaw.replace(/-/g, '+').replace(/_/g, '/');
          const decodedJson     = atob(correctedBase64);
          const products        = JSON.parse(decodedJson);
          const listEl          = document.getElementById("ordered-products");
          listEl.innerHTML = "";
          products.forEach(p => {
            const li = document.createElement("li");
            li.innerText = p;
            listEl.appendChild(li);
          });
        } catch (e) {
          console.error("Kunde inte tolka produktlistan:", e);
        }
      }
    }

    function updateOrderStatus(status) {
      const el = document.getElementById("order-status");
      if (status === "levereras") {
        el.style.color = "blue";
        el.innerText = "levereras";
      } else {
        el.style.color = "blue";
        el.innerText = "i kö";
      }
    }

    function pollOrderStatus() {
      const params = new URLSearchParams(window.location.search);
      const currentOrder = params.get("ordernumber");
      if (!currentOrder) return;

      fetch(`/order_status/${currentOrder}`)
        .then(r => r.json())
        .then(data => updateOrderStatus(data.status))
        .catch(console.error)
        .finally(() => setTimeout(pollOrderStatus, 2000));
    }

    function LoadDrone(droneID, x, y, status) {
      const obj = document.getElementById("map");
      $(obj).ready(() => {
        const svgDoc = obj.getSVGDocument();
        const svg    = svgDoc.getElementById("map-svg");
        let circle   = svgDoc.getElementById(droneID);
        const color  = (status === 'idle') ? 'green' : 'red';

        if (!circle) {
          circle = svgDoc.createElementNS("http://www.w3.org/2000/svg", "circle");
          circle.setAttribute('r', '5');
          circle.setAttribute('id', droneID);
          svg.appendChild(circle);
        }
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y);
        circle.setAttribute('fill', color);
      });
    }

    function pollDrones() {
      $.ajax({ url: 'http://localhost:5000/get_drones' })
        .done(res => {
          Object.entries(res).forEach(([id, info]) => {
            LoadDrone(id, info.longitude, info.latitude, info.status);
          });
        })
        .always(() => setTimeout(pollDrones, 10));
    }

    function pollQueuePosition() {
      const params = new URLSearchParams(window.location.search);
      const currentOrder = params.get("ordernumber");
      if (!currentOrder) return;

      fetch('http://localhost:5002/queue-length')
        .then(r => r.json())
        .then(data => {
          const el = document.getElementById("order-status");
          if (el.innerText.startsWith("i kö")) {
            el.innerText = `i kö (plats ${data.queue_length})`;
          }
        })
        .catch(console.error)
        .finally(() => setTimeout(pollQueuePosition, 2000));
    }

    function goBackToHome() {
      window.location.href = "/";
    }
    function goToQRScanner() {
      window.location.href = "/qr" + window.location.search;
    }

    loadOrderDataFromQuery();
    pollOrderStatus();
    pollDrones();
    pollQueuePosition();
  </script>
</body>
</html>
