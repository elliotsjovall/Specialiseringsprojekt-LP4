<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <title>Drone in Lund</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
  <p id="order-info"></p>
  <p id="destination-info"></p>   

  <object id="map" data="static/images/lund-map.svg" type="image/svg+xml"></object>

  <script type="text/javascript">
    function displayOrderNumberFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const orderNr = params.get("ordernumber") || "-";
      const destination = params.get("adress") || "Unknown"; //ändrat
      document.getElementById("order-info").innerText = "Ordernummer: " + orderNr;
      document.getElementById("destination-info").innerText = "Destination: " + destination; //ändrat
    }
    displayOrderNumberFromQuery();

    function LoadDrone(droneID, x, y, status) {
      var doc = document.getElementById("map");
      $(doc).ready(function() {
        var doc_svg = doc.getSVGDocument();
        var svg = doc_svg.getElementById("map-svg");
        var circleNode = svg.getElementById(droneID);

        var color = (status === 'idle') ? 'green' : 'red';

        if(circleNode == null) {
          circleNode = doc_svg.createElementNS("http://www.w3.org/2000/svg", "circle");
          circleNode.setAttributeNS(null, 'cx', x);
          circleNode.setAttributeNS(null, 'cy', y);
          circleNode.setAttributeNS(null, 'r', '5');
          circleNode.setAttributeNS(null, 'fill', color);
          circleNode.setAttributeNS(null, 'id', droneID);
          svg.appendChild(circleNode);
        } else {
          circleNode.setAttributeNS(null, 'cx', x);
          circleNode.setAttributeNS(null, 'cy', y);
          circleNode.setAttributeNS(null, 'fill', color);
        }
      });
    }
    
    var set_delay = 1000;
    function pollDrones() {
      $.ajax({
        url: 'http://localhost:5000/get_drones'
      })
      .done(function(server_response) {
        var avalaible_drones = Object.keys(server_response);
        for (const droneID of avalaible_drones){
          var x = server_response[droneID].longitude;
          var y = server_response[droneID].latitude;
          var status = server_response[droneID].status;
          LoadDrone(droneID, x, y, status);
        }
      })
      .always(function() {
        setTimeout(pollDrones, set_delay);
      });
    }
    pollDrones();
  </script>
</body>
</html>
