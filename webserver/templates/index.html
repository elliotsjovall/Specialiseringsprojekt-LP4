<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <title>Drone in Lund</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <link rel="stylesheet" type="text/css" href="static/style.css"> <!-- Koppla CSS -->
</head>


<body>
  
  <!-- Container för orderinformation -->
  <div class="order-info-container">
    <h3>Orderinformation</h3>
    <p><strong>Ordernummer:</strong> <span id="order-number">-</span></p>
    <p><strong>Leveransadress:</strong> <span id="delivery-address">-</span></p>
    <p><strong>Beställda produkter:</strong></p>
    <ul id="ordered-products"></ul>
    <p><strong>Total vikt:</strong> <span id="total-weight">-></span></p>

     <!-- Ny knapp för att gå tillbaka till huvudsidan -->
     <button id="back-to-home" onclick="goBackToHome()">Till Huvudsidan</button>
  </div>

  <p id="order-info"></p>

  <object id="map" data="static/images/lund-map.svg" type="image/svg+xml"></object>

  <script type="text/javascript">

        // Laddar orderdata från URL:en och fyller ut i rutan
    function loadOrderDataFromQuery() {
      const params = new URLSearchParams(window.location.search);

      const orderNr = params.get("ordernumber") || "-";
      const address = params.get("address")?.replace(/\+/g, ' ') || "-";
      const weight = params.get("weight") || "-";
      const productListRaw = params.get("products");

      document.getElementById("order-number").innerText = orderNr;
      document.getElementById("delivery-address").innerText = address;
      document.getElementById("total-weight").innerText = weight + " mg";
     
      if (productListRaw) {
        try {
          // Dekoda base64 URL-safe → vanlig base64
          const correctedBase64 = productListRaw.replace(/-/g, '+').replace(/_/g, '/');
          const decodedJson = atob(correctedBase64);
          const products = JSON.parse(decodedJson);

          const listElement = document.getElementById("ordered-products");
          listElement.innerHTML = '';

          products.forEach(product => {
            const li = document.createElement("li");
            li.innerText = product;
            listElement.appendChild(li);
          });
        } catch (e) {
          console.error("Kunde inte tolka produktlistan:", e);
        }
      }
    }


    // Kör vid sidladdning
  loadOrderDataFromQuery();
    

    function LoadDrone(droneID, x, y, status) {
      var doc = document.getElementById("map");
      $(doc).ready(function() {
        var doc_svg = doc.getSVGDocument();
        var svg = doc_svg.getElementById("map-svg");
        var circleNode = svg.getElementById(droneID);

        var color = (status === 'idle') ? 'green' : 'red';

        if(circleNode == null) {
          circleNode = doc_svg.createElementNS("http://www.w3.org/2000/svg", "circle");
          circleNode.setAttributeNS(null, 'cx', x);
          circleNode.setAttributeNS(null, 'cy', y);
          circleNode.setAttributeNS(null, 'r', '5');
          circleNode.setAttributeNS(null, 'fill', color);
          circleNode.setAttributeNS(null, 'id', droneID);
          svg.appendChild(circleNode);
        } else {
          circleNode.setAttributeNS(null, 'cx', x);
          circleNode.setAttributeNS(null, 'cy', y);
          circleNode.setAttributeNS(null, 'fill', color);
        }
      });
    }
    
    var set_delay = 1000;
    function pollDrones() {
      $.ajax({
        url: 'http://localhost:5000/get_drones'
      })
      .done(function(server_response) {
        var avalaible_drones = Object.keys(server_response);
        for (const droneID of avalaible_drones){
          var x = server_response[droneID].longitude;
          var y = server_response[droneID].latitude;
          var status = server_response[droneID].status;
          LoadDrone(droneID, x, y, status);
        }
      })
      .always(function() {
        setTimeout(pollDrones, set_delay);
      });
    }
    // Funktion som navigerar användaren tillbaka till huvudsidan
    function goBackToHome() {
      window.location.href = "/";  // Byt till din huvudsida (kan vara en annan URL)
    }
    
    pollDrones();

  </script>
</body>
</html>
